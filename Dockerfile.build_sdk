FROM qzhhhi/librmcs-ci AS build

SHELL ["/bin/bash", "-c"]

ARG WITH_SOURCE=true

COPY <<EOF /src/CMakeLists.txt
cmake_minimum_required(VERSION 3.28)
project(librmcs_wrapper VERSION 3 LANGUAGES C CXX)
set(LIBRMCS_PROJECT_VERSION "__LIBRMCS_PROJECT_VERSION_PLACEHOLDER__")
set(LIBRMCS_DEBIAN_VERSION "__LIBRMCS_DEBIAN_VERSION_PLACEHOLDER__")
add_subdirectory(host)
EOF

COPY <<EOF /src/CMakePresets.json
{
    "version": 4,
    "include": [
        "host/CMakePresets.json"
    ]
}
EOF

WORKDIR /src-full
RUN --mount=type=bind,target=/src-full,source=.,readonly \
    LIBRMCS_PROJECT_VERSION=$(.scripts/generate_version) \
    && LIBRMCS_DEBIAN_VERSION=$(.scripts/generate_version --format debian) \
    && echo "LIBRMCS_PROJECT_VERSION=${LIBRMCS_PROJECT_VERSION}" >> /env.sh \
    && echo "LIBRMCS_DEBIAN_VERSION=${LIBRMCS_DEBIAN_VERSION}" >> /env.sh \
    && cp -r core host LICENSE /src \
    && sed -i "s/__LIBRMCS_PROJECT_VERSION_PLACEHOLDER__/${LIBRMCS_PROJECT_VERSION}/g" \
        /src/CMakeLists.txt \
    && sed -i "s/__LIBRMCS_DEBIAN_VERSION_PLACEHOLDER__/${LIBRMCS_DEBIAN_VERSION}/g" \
        /src/CMakeLists.txt

WORKDIR /output

RUN source /env.sh \
    && if [ "${WITH_SOURCE}" = "true" ]; then \
        SDK_SRC_NAME=librmcs-sdk-src-${LIBRMCS_PROJECT_VERSION}; \
        cp -r /src ${SDK_SRC_NAME}; \
        zip -r ${SDK_SRC_NAME}.zip ${SDK_SRC_NAME}; \
        rm -rf ${SDK_SRC_NAME}; \
    fi

RUN source /env.sh \
    && cmake --preset linux-debug -B build-debug /src \
    && cmake --build build-debug \
    && cd build-debug && cpack -G DEB && cd .. \
    && mv build-debug/*.deb . \
    && cmake --preset linux-release -B build-release /src \
    && cmake --build build-release \
    && cd build-release && cpack -G DEB && cd .. \
    && mv build-release/*.deb . \
    && rm -rf build*

FROM scratch AS output
COPY --from=build /output/ /
